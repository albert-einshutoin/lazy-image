name: Fuzz

on:
  schedule:
    # Run nightly at 3:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      fuzz_duration:
        description: 'Fuzz duration in seconds per target'
        required: false
        default: '300'
      target:
        description: 'Specific target to fuzz (leave empty for all)'
        required: false
        default: ''

env:
  CARGO_TERM_COLOR: always
  # Fuzz duration: 5 minutes per target for scheduled runs
  FUZZ_DURATION: ${{ github.event.inputs.fuzz_duration || '300' }}

jobs:
  fuzz:
    name: Fuzz ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - decode_from_buffer
          - pipeline_ops
          - inspect_header
          - encode_to_format
          - icc_profile
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-action@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake nasm

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            fuzz/target
          key: fuzz-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            fuzz-${{ runner.os }}-

      - name: Download corpus
        continue-on-error: true
        uses: actions/cache@v4
        with:
          path: fuzz/corpus/${{ matrix.target }}
          key: corpus-${{ matrix.target }}-${{ github.run_id }}
          restore-keys: |
            corpus-${{ matrix.target }}-

      - name: Run fuzzer
        if: ${{ github.event.inputs.target == '' || github.event.inputs.target == matrix.target }}
        run: |
          cd fuzz
          timeout ${FUZZ_DURATION}s cargo +nightly fuzz run ${{ matrix.target }} -- \
            -max_len=1048576 \
            -max_total_time=${FUZZ_DURATION} \
            || true

      - name: Save corpus
        if: always()
        uses: actions/cache/save@v4
        with:
          path: fuzz/corpus/${{ matrix.target }}
          key: corpus-${{ matrix.target }}-${{ github.run_id }}

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: crash-${{ matrix.target }}
          path: |
            fuzz/artifacts/${{ matrix.target }}
          if-no-files-found: ignore

  report:
    name: Fuzz Report
    needs: fuzz
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all crash artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: crash-*
          merge-multiple: true
          path: crashes

      - name: Check for crashes
        run: |
          if [ -d crashes ] && [ "$(ls -A crashes 2>/dev/null)" ]; then
            echo "::error::Fuzzing found crashes!"
            ls -la crashes/
            exit 1
          else
            echo "No crashes found"
          fi

      - name: Create issue on crash
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const crashes = fs.readdirSync('crashes').filter(f => !f.startsWith('.'));

            if (crashes.length > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Fuzz] Crash detected in nightly fuzzing`,
                body: `## Fuzzing Crash Report\n\nCrashes found in: ${crashes.join(', ')}\n\nSee [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
                labels: ['bug', 'security']
              });
            }
