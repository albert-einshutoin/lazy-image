name: CI

env:
  DEBUG: napi:*
  APP_NAME: lazy-image
  MACOSX_DEPLOYMENT_TARGET: '10.13'

permissions:
  contents: write
  id-token: write

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        settings:
          # macOS
          - host: macos-latest
            target: x86_64-apple-darwin
            build: npm run build -- --target x86_64-apple-darwin
          - host: macos-latest
            target: aarch64-apple-darwin
            build: npm run build -- --target aarch64-apple-darwin
          
          # Windows
          - host: windows-latest
            target: x86_64-pc-windows-msvc
            build: npm run build -- --target x86_64-pc-windows-msvc
          
          # Linux (glibc)
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            build: |
              sudo apt-get update
              sudo apt-get install -y nasm
              npm run build -- --target x86_64-unknown-linux-gnu
          
          # Linux (musl)
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
            build: |
              sudo apt-get update
              sudo apt-get install -y musl-tools nasm
              npm run build -- --target x86_64-unknown-linux-musl

    name: Build - ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.host }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Install NASM (macOS)
        if: matrix.settings.host == 'macos-latest'
        run: brew install nasm

      - name: Install NASM (Windows)
        if: matrix.settings.host == 'windows-latest'
        uses: ilammy/setup-nasm@v1

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: ${{ matrix.settings.build }}
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.settings.target }}
          path: "*.node"
          if-no-files-found: error

  test-rust:
    name: Rust Tests
    runs-on: ${{ matrix.host }}
    strategy:
      fail-fast: false
      matrix:
        host: [ubuntu-latest, macos-14]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install NASM (Linux)
        if: matrix.host == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y nasm

      - name: Install NASM (macOS)
        if: matrix.host == 'macos-14'
        run: brew install nasm

      - name: Run Rust tests (without NAPI features)
        run: cargo test --no-default-features --no-fail-fast

      - name: Run Rust tests (release mode, without NAPI features)
        run: cargo test --no-default-features --release

      - name: Run NAPI feature tests
        run: cargo test --features napi --test napi_tests --no-fail-fast

  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install NASM
        run: sudo apt-get update && sudo apt-get install -y nasm

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: .

      - name: Create test image
        run: node test/helpers/create-test-image.js

      - name: Test
        run: npm test

  coverage:
    name: Coverage
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install NASM
        run: sudo apt-get update && sudo apt-get install -y nasm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage
        run: cargo llvm-cov --no-default-features --lcov --output-path lcov.info

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  leak-detection:
    name: Memory Leak Detection (ASan)
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y nasm

      # Cache Cargo dependencies to speed up builds
      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-asan"

      - name: Run Stress Test with AddressSanitizer
        env:
          RUSTFLAGS: "-Zsanitizer=address"
          # Enable leak detection, abort on error, and symbolize stack traces
          ASAN_OPTIONS: "detect_leaks=1:abort_on_error=1:symbolize=1"
          RUST_BACKTRACE: 1
        run: |
          # Run stress test with optimized dependencies (see Cargo.toml profile.dev.package)
          cargo run --example stress_test \
            --target x86_64-unknown-linux-gnu \
            --no-default-features --features stress \
            -- --iterations 5

  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # Required for OIDC authentication
    needs:
      - build
      - test
    # Only publish on tag releases (semantic versioning) or manual workflow dispatch
    # CI/README changes are tested by build/test jobs, but don't trigger npm publish
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          scope: '@alberteinshutoin'
      
      # Note: OIDC authentication only works during npm publish
      # npm whoami will not work with OIDC - this is expected behavior
      # See: https://docs.npmjs.com/trusted-publishers#limitations-and-future-improvements

      - name: Install dependencies
        run: npm ci

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare artifacts for napi prepublish
        run: |
          # napi prepublish expects .node files in npm/{platform}/ directories
          # Create npm directory structure and copy .node files to correct locations
          mkdir -p npm
          
          # Map Rust target triple to npm platform names
          # napi prepublish uses npm platform names, not Rust target triples
          declare -A platform_map=(
            ["x86_64-apple-darwin"]="darwin-x64"
            ["aarch64-apple-darwin"]="darwin-arm64"
            ["x86_64-pc-windows-msvc"]="win32-x64-msvc"
            ["x86_64-unknown-linux-gnu"]="linux-x64-gnu"
            ["x86_64-unknown-linux-musl"]="linux-x64-musl"
          )
          
          # Process each artifact directory
          for artifact_dir in artifacts/*/; do
            if [ ! -d "$artifact_dir" ]; then
              continue
            fi
            
            artifact_name=$(basename "$artifact_dir")
            echo "Processing artifact: $artifact_name"
            
            # Extract Rust target from artifact name (bindings-{target})
            rust_target="${artifact_name#bindings-}"
            
            # Get npm platform name
            platform="${platform_map[$rust_target]}"
            
            if [ -z "$platform" ]; then
              echo "⚠️  Unknown platform mapping for: $rust_target"
              continue
            fi
            
            # Find .node file in artifact directory
            node_file=$(find "$artifact_dir" -name "*.node" -type f | head -1)
            
            if [ -z "$node_file" ]; then
              echo "❌ No .node file found in $artifact_dir"
              continue
            fi
            
            # Create platform directory and copy .node file with correct name
            mkdir -p "npm/$platform"
            # napi prepublish expects: npm/{platform}/lazy-image.{platform}.node
            target_name="lazy-image.${platform}.node"
            cp "$node_file" "npm/$platform/$target_name"
            echo "✅ Copied $node_file -> npm/$platform/$target_name"
          done
          
          # Verify all required platforms are present
          echo ""
          echo "=== Platform directories created ==="
          find npm -type d -maxdepth 1 | sort
          echo ""
          echo "=== Node files ==="
          find npm -name "*.node" | sort
          echo ""
          
          # Check if all required platforms are present
          required_platforms=("darwin-x64" "darwin-arm64" "win32-x64-msvc" "linux-x64-gnu" "linux-x64-musl")
          missing=0
          for platform in "${required_platforms[@]}"; do
            if [ ! -f "npm/$platform/lazy-image.$platform.node" ]; then
              echo "❌ Missing: npm/$platform/lazy-image.$platform.node"
              missing=$((missing + 1))
            else
              echo "✅ Found: npm/$platform/lazy-image.$platform.node"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "ERROR: Missing $missing platform(s). Cannot proceed with napi prepublish."
            exit 1
          fi
          
          echo "✅ All required platforms are present"
          
          # Create skeleton package.json for each platform
          # napi prepublish needs these to generate the final package.json
          echo ""
          echo "=== Creating skeleton package.json for each platform ==="
          VERSION=$(node -p "require('./package.json').version")
          for platform in "${required_platforms[@]}"; do
            pkg_name="@alberteinshutoin/lazy-image-${platform}"
            os_part=$(echo "$platform" | cut -d'-' -f1)
            cpu_part=$(echo "$platform" | cut -d'-' -f2)
            node -e "
              const fs = require('fs');
              const pkg = {
                name: '$pkg_name',
                version: '$VERSION',
                description: 'Next-generation image processing engine - smaller files than sharp, powered by Rust + mozjpeg',
                main: 'lazy-image.${platform}.node',
                os: ['$os_part'],
                cpu: ['$cpu_part'],
                files: ['lazy-image.${platform}.node'],
                license: 'MIT',
                publishConfig: {
                  access: 'public'
                },
                repository: {
                  type: 'git',
                  url: 'https://github.com/albert-einshutoin/lazy-image.git'
                },
                engines: {
                  node: '>= 18'
                }
              };
              fs.writeFileSync('npm/$platform/package.json', JSON.stringify(pkg, null, 2));
            "
            echo "✅ Created npm/$platform/package.json"
          done

      - name: Finalize npm packages
        run: |
          # Verify structure
          echo "=== Verifying structure ==="
          for platform in darwin-x64 darwin-arm64 win32-x64-msvc linux-x64-gnu linux-x64-musl; do
            if [ -f "npm/$platform/lazy-image.$platform.node" ] && [ -f "npm/$platform/package.json" ]; then
              echo "✅ npm/$platform/ - both .node and package.json exist"
            else
              echo "❌ npm/$platform/ - missing files"
              exit 1
            fi
          done
          
          # Verify package.json contents
          echo ""
          echo "=== Verifying package.json contents ==="
          for platform in darwin-x64 darwin-arm64 win32-x64-msvc linux-x64-gnu linux-x64-musl; do
            echo "Package: $platform"
            cat "npm/$platform/package.json" | jq -r '.name, .version, .main' || cat "npm/$platform/package.json"
            echo ""
          done
          
          # List generated packages
          echo "=== Generated packages ==="
          ls -la npm/ || true
          echo ""
          echo "=== Package directories ==="
          find npm -type d -maxdepth 1 || true
          echo ""
          echo "=== Package contents ==="
          for pkg_dir in npm/*/; do
            if [ -d "$pkg_dir" ]; then
              pkg_name=$(basename "$pkg_dir")
              echo "Package: $pkg_name"
              ls -la "$pkg_dir"
              echo ""
            fi
          done

      - name: Publish platform packages
        run: |
          set +e  # Don't exit on error, we want to try all packages
          published=0
          failed=0
          failed_packages=()
          
          for pkg in npm/*; do
            if [ -d "$pkg" ]; then
              pkg_name=$(basename "$pkg")
              echo ""
              echo "=========================================="
              echo "Publishing $pkg_name..."
              echo "=========================================="
              cd "$pkg"
              
              # Verify package.json exists and has publishConfig
              if [ ! -f "package.json" ]; then
                echo "❌ package.json not found in $pkg_name"
                failed=$((failed + 1))
                failed_packages+=("$pkg_name")
                cd ../..
                continue
              fi
              
              # Check if publishConfig is set
              if ! grep -q '"publishConfig"' package.json; then
                echo "⚠️  Warning: publishConfig not found in package.json"
              fi
              
              # Try to publish with provenance (works with OIDC or NPM_TOKEN)
              if npm publish --access public --provenance 2>&1; then
                echo "✅ Successfully published $pkg_name"
                published=$((published + 1))
              else
                publish_error=$?
                echo "❌ Failed to publish $pkg_name (exit code: $publish_error)"
                echo ""
                echo "Common causes:"
                echo "1. For new packages: NPM_TOKEN secret is required for initial publish"
                echo "2. For existing packages: Trusted Publisher must be configured in npm"
                echo "3. Package already exists with same version (check npm registry)"
                echo "4. Invalid package.json"
                echo ""
                failed=$((failed + 1))
                failed_packages+=("$pkg_name")
              fi
              cd ../..
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "Publish Summary"
          echo "=========================================="
          echo "Published: $published"
          echo "Failed: $failed"
          if [ ${#failed_packages[@]} -gt 0 ]; then
            echo "Failed packages: ${failed_packages[*]}"
          fi
          
          if [ $failed -gt 0 ]; then
            echo ""
            echo "❌ Some packages failed to publish"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. For NEW packages: Set NPM_TOKEN secret in GitHub repository settings"
            echo "2. For existing packages: Configure Trusted Publisher in npm"
            echo "3. Check if you have access to @alberteinshutoin scope"
            echo "4. Try publishing manually: cd npm/<platform> && npm publish --access public"
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish main package
        run: |
          # Remove .node files from main package (they're in platform packages now)
          rm -f *.node
          # Restore original package.json if napi prepublish modified it
          git checkout package.json || true
          # Publish without running prepublishOnly (we already ran napi prepublish manually)
          npm publish --access public --provenance --ignore-scripts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
